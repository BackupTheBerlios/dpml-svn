<?xml version="1.0" encoding="UTF-8" ?>
<!--
 * Copyright 2004-2005 Stephen J. McConnell.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.dpml.net/central/about/legal/
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->

<project name="dpml-http-demo" default="install" basedir="." 
    xmlns:transit="antlib:net.dpml.transit" 
    xmlns:x="dpml:depot"
    xmlns:c="dpml:metro">

  <transit:import uri="local:template:dpml/tools/standard"/>

  <target name="build" depends="standard.build">

    <x:plugin uri="link:plugin:dpml/metro/dpml-metro-tools"/>

    <c:type class="net.dpml.http.demo.Demo" threadsafe="true" name="demo">
      <parts>
        <component type="net.dpml.http.impl.HttpServerImpl" key="server" collection="hard">
          <context>
            <entry key="trace" value="false"/>
            <entry key="anonymous" value="false"/>
            <entry key="gracefulStop" value="true"/>
            <entry key="requestsPerGC" value="1000"/>
          </context>
        </component>
        <component key="requestLog" type="net.dpml.http.impl.NcsaRequestLog" collection="hard">
          <context>
            <entry key="filename" value="$${dpml.data}/logs/http/static_request.log"/>
            <entry key="append" value="true"/>
            <entry key="extended" value="true"/>
          </context>
        </component>
        <component type="net.dpml.http.impl.SocketListener" key="socketListener" collection="hard"
            activation="false">
          <context>
            <entry key="httpServer" uri="service:net.dpml.http.spi.HttpService"/>
            <entry key="port" value="8080"/>
          </context>
        </component>
        <component key="context" type="net.dpml.http.impl.HttpContextImpl" collection="hard">
          <context>
            <entry key="server" uri="service:net.dpml.http.spi.HttpService"/>
            <entry key="requestLog" uri="service:org.mortbay.http.RequestLog"/>
            <entry key="tempDirectory" value="$${java.io.tmpdir}/http/context"/>
            <entry key="contextPath" value="/"/>
            <entry key="gracefulStop" value="true"/>
          </context>
        </component>
        <component key="httpHandler" type="net.dpml.http.impl.ResourceHandler" collection="hard">
          <context>
            <entry key="name" value="resource-handler"/>
            <entry key="dirAllowed" value="true"/>
            <entry key="allowedMethods" value="GET"/>
            <entry key="httpContext" uri="service:net.dpml.http.spi.HttpContextService"/>
          </context>
        </component>
        <component key="notFoundHandler" type="net.dpml.http.impl.NotFoundHandler" collection="hard">
          <context>
            <entry key="name" value="not-found-handler"/>
            <entry key="httpContext" uri="service:net.dpml.http.spi.HttpContextService"/>
          </context>
        </component>
      </parts>
    </c:type>
    <c:component name="demo" type="net.dpml.http.demo.Demo"/>
  </target>

  <target name="package" depends="standard.package">
    <mkdir dir="target/test"/>
    <x:property name="part.filename" feature="filename" type="part"/>
    <copy file="target/deliverables/parts/${part.filename}" toFile="target/test/demo.part"/>
  </target>

  <target name="install" depends="standard.install">
    <mkdir dir="${dpml.prefs}"/>
    <copy toDir="${dpml.prefs}">
      <fileset dir="${project.target.dir}/prefs">
        <include name="**/*"/>
      </fileset>
    </copy>
  </target>

</project>

